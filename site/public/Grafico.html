<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popularidade das plantas </title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/funcoes.js">


    </script>

</head>

<body id="bodygrafico" onload="obterDadosGrafico()">
    <nav id="menu" class="menu">
        <ul class="item1">
            <li>
                <h1><a href="index.html" style="color:  rgb(0, 0, 0);">Cultivo para vida</a>
                    <hr>
                </h1>
            </li>
        </ul>
        <ul class="item2">
            <li>
                <h1><a href="tutorial.html" style="color:  rgb(0, 0, 0);">Tutorial</a>
                    <hr>
                </h1>
            </li>
        </ul>
        <ul class="item3roda">
            <li>
                <h1><a href="Simulador_tempo.html" style="color:  rgb(0, 0, 0);">simulador de crescimento</a>
                    <hr>
                </h1>
            </li>
        </ul>

        <ul class="item3roda">
            <li>
                <h1><a href="Grafico.html" style="color:  rgb(0, 0, 0);">Graficos</a>
                    <hr>
                </h1>
            </li>
        </ul>




        <ul class="item3roda">
            <li>
                <h1><a href="Curiosidades.html" style="color:  rgb(0, 0, 0);">Curiosidades</a>
                    <hr>
                </h1>
            </li>
        </ul>


        <ul class="item4">
            <li>
                <h1><a href="matematica.html" style="color: rgb(0, 0, 0);">Agua para vida</a>
                    <hr>
                </h1>
            </li>
        </ul>
        <ul class="item5">
            <li>
                <h1><a href="quem_sou.html" style="color:rgb(0, 0, 0)">Quem sou</a>
                    <hr>
                </h1>
            </li>
        </ul>
    </nav>
    <div class="grafico">
        <div class="grafico1">
            <canvas id="myChart"></canvas>
        </div>
    </div>
        <div class="grafico">
            <div class="grafico2">
                <canvas id="myChart2"></canvas>
            </div>
        </div>
</body>



</html>
<script>
    let proximaAtualizacao;

    window.onload = obterDadosGraficos();

    function obterDadosGraficos() {
        obterDadosGrafico(1)
        obterDadosGrafico(2)

        
    }

    function obterDadosGrafico(idplanta) {

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/buscartop3/${idplanta}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);


                    plotarGrafico(resposta, idplanta);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    function obterDadosGrafico(idplanta) {

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/buscartop3/${idplanta}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta2) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta2)}`);


                    plotarGrafico(resposta2, idplanta);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    function plotarGrafico(resposta2, idplanta) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'top 3',
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            },
            {
                label: '',
                data: [],
                fill: false,
                borderColor: 'rgb(199, 52, 52)',
                tension: 0.1
            }]
        };
        
        let labels2 = [];

// Criando estrutura para plotar gráfico - dados
let dados2 = {
    labels: labels,
    datasets: [{
        label: 'top 3',
        data: [],
        fill: false,
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
    },
    {
        label: '',
        data: [],
        fill: false,
        borderColor: 'rgb(199, 52, 52)',
        tension: 0.1
    }]
};

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta2)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta2.length; i++) {
            var registro = resposta2[i];
            labels.push(registro.planta);
            dados.datasets[0].data.push(registro.planta);
            dados.datasets[1].data.push(registro.voto);
            console.log(registro.momento_grafico)
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
        };
        const config2 = {
            type: 'bar',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart2 = new Chart(
            document.getElementById('myChart2'),
            config2
        );
        let myChart = new Chart(
            document.getElementById('myChart'),
            config
        );

        setTimeout(() => atualizarGrafico(idplanta, dados, myChart), 2000);
        
            function plotarGrafico(resposta, idplantas) {
            console.log('iniciando plotagem do gráfico...');

        }
        function atualizarGrafico(idplanta, dados, myChart) {

            fetch(`/medidas/buscartop3/${idplanta}`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (novoRegistro) {

                        console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                        console.log(`Dados atuais do gráfico:`);
                        console.log(dados);

                        let avisoCaptura = document.getElementById(`avisoCaptura${idplanta}`)



                        if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                            console.log("---------------------------------------------------------------")
                            console.log("Como não há dados novos para captura, o gráfico não atualizará.")

                            console.log("Horário do novo dado capturado:")
                            console.log(novoRegistro[0].momento_grafico)
                            console.log("Horário do último dado capturado:")
                            console.log(dados.labels[dados.labels.length - 1])
                            console.log("---------------------------------------------------------------")
                        } else {
                            // tirando e colocando valores no gráfico
                            // apagar o primeiro
                            dados.labels.push(novoRegistro[0].planta); // incluir um novo momento
                        }

                        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                        proximaAtualizacao = setTimeout(() => atualizarGrafico(idplanta, dados, myChart), 2000);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idplanta, dados, myChart), 2000);
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });
        }
       
    }

</script>